---
- name: Test role for certificate management
  hosts: localhost
  connection: local
  become: false

  vars:
    cf_api_token: "{{ lookup('env', 'CF_API_TOKEN_SECRET') }}"
    cf_zone_id: "{{ lookup('env', 'CF_ZONE_ID_SECRET') }}"

    cf_certificate_hostnames: "{{ lookup('env', 'CF_CERTIFICATE_HOSTNAMES_VAR') | default('', true) }}"

    # Role variables configured for testing
    cf_certificate_install_path: >-
      /tmp/cf_certs_test_{{ lookup('env', 'GITHUB_RUN_ID') }}_{{ lookup('env', 'GITHUB_RUN_ATTEMPT') }}/
    cf_certificate_file: "{{ cf_certificate_install_path }}origin.pem"
    cf_key_file: "{{ cf_certificate_install_path }}origin.key"
    cf_certificate_validity_days: 7

  pre_tasks:
    - name: "DEBUG: Initial value of cf_certificate_hostnames from environment"
      ansible.builtin.debug:
        msg: "Raw cf_certificate_hostnames from env is '{{ cf_certificate_hostnames }}'
        (Type: {{ cf_certificate_hostnames | type_debug }})"
      tags: [debug_ci]

    - name: Ensure certificate installation directory exists
      ansible.builtin.file:
        path: "{{ cf_certificate_install_path }}"
        state: directory
        mode: '0755'
      tags: always

  roles:
    - role: cloudflare_origin_cert

  handlers:
    - name: Restart webserver (CI Test Handler)
      ansible.builtin.debug:
        msg: "HANDLER: 'Restart webserver' for service '{{ webserver_service_name }}' was triggered."
      listen: Restart webserver
